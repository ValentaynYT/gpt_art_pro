<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–∞–Ω–µ–ª—å –∑–∞–∫–∞–∑—á–∏–∫–∞</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: all 0.2s ease;
        }

        body {
            background: rgb(39,40,43);
            color: white;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding-top: 120px;
        }

        .top-menu {
            display: flex;
            justify-content: center;
            gap: 20px;
            width: 100%;
            padding: 25px;
            background-color: rgb(22, 23, 39);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            position: fixed;
            top: 0;
            z-index: 1000;
        }

        .top-menu a {
            padding: 12px 25px;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            border-radius: 50px;
            background: linear-gradient(0deg, rgba(93,113,245,1) 34%, rgba(76,81,255,1) 78%);
            color: white;
            text-decoration: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            position: relative;
        }

        .top-menu a:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(93, 113, 245, 0.4);
        }

        .dashboard-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 30px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 1200px;
            margin-bottom: 40px;
            gap: 25px;
        }

        .dashboard-section {
            width: 100%;
            padding: 25px;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            border-radius: 12px;
            border: 1px solid rgba(255,255,255, 0.1);
            backdrop-filter: blur(10px);
        }

        .dashboard-section h2 {
            margin-top: 0;
            color: #00ff88;
            font-size: 1.5em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .dashboard-section p {
            font-size: 1.1em;
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .dashboard-link {
            display: inline-block;
            margin-top: 15px;
            padding: 12px 25px;
            background: rgba(93, 113, 245, 0.3);
            border-radius: 8px;
            color: white;
            text-decoration: none;
            font-weight: bold;
            border: 1px solid rgba(93, 113, 245, 0.5);
        }

        .dashboard-link:hover {
            background: rgba(93, 113, 245, 0.6);
            transform: translateY(-2px);
        }

        .profile-button {
            position: absolute;
            right: 50px;
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 12px;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: linear-gradient(0deg, rgba(93,113,245,1) 34%, rgba(76,81,255,1) 78%);
        }

        .profile-button:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(93, 113, 245, 0.4);
        }

        .profile-modal {
            display: none;
            position: absolute;
            right: 50px;
            top: 75px;
            background-color: white;
            color: black;
            width: 180px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            z-index: 1001;
            overflow: hidden;
            border: 1px solid #e0e0e0;
        }

        .profile-modal a {
            display: block;
            padding: 15px 20px;
            color: #333;
            text-decoration: none;
            text-align: left;
            font-size: 14px;
            border-bottom: 1px solid #f0f0f0;
        }

        .profile-modal a:hover {
            background-color: #f8f9fa;
            color: #5d71f5;
        }

        .profile-modal a:last-child {
            border-bottom: none;
        }

        .notification-badge {
            background: #ff4757;
            color: white;
            border-radius: 50%;
            padding: 3px 8px;
            font-size: 12px;
            margin-left: 8px;
            font-weight: bold;
            min-width: 20px;
            height: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .welcome-section {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, rgba(93,113,245,0.2) 0%, rgba(0,255,136,0.1) 100%);
            border-radius: 12px;
            margin-bottom: 10px;
            width: 100%;
        }

        .welcome-section h1 {
            color: #00ff88;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .quick-search-form {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            align-items: center;
        }

        .quick-search-form input {
            padding: 12px 15px;
            width: 70%;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 14px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .quick-search-form input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .quick-search-form input:focus {
            outline: none;
            border-color: #5d71f5;
            background: rgba(255, 255, 255, 0.15);
        }

        .quick-search-form button {
            padding: 12px 25px;
            background: linear-gradient(0deg, rgba(93,113,245,1) 34%, rgba(76,81,255,1) 78%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        .quick-search-form button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(93, 113, 245, 0.4);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #5d71f5;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            color: rgba(255, 255, 255, 0.8);
        }

        .products-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            overflow: hidden;
        }

        .products-table th, .products-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .products-table th {
            background: rgba(93, 113, 245, 0.3);
            font-weight: bold;
            text-transform: uppercase;
            font-size: 14px;
        }

        .products-table tr:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .shelf-name {
            background: rgba(93, 113, 245, 0.2);
            padding: 5px 10px;
            border-radius: 4px;
            display: inline-block;
        }

        .no-shelf {
            color: rgba(255, 255, 255, 0.4);
            font-style: italic;
        }

        .product-content {
            max-width: 300px;
            word-wrap: break-word;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: rgba(255, 255, 255, 0.6);
        }

        .action-button {
            padding: 8px 12px;
            background: rgba(0, 255, 136, 0.3);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 14px;
            margin-right: 5px;
        }

        .action-button:hover {
            background: rgba(0, 255, 136, 0.6);
        }

        .action-button.secondary {
            background: rgba(93, 113, 245, 0.3);
        }

        .action-button.secondary:hover {
            background: rgba(93, 113, 245, 0.6);
        }

        @media (max-width: 768px) {
            body {
                padding-top: 140px;
            }

            .top-menu {
                flex-wrap: wrap;
                padding: 15px;
                gap: 10px;
            }

            .top-menu a {
                padding: 10px 15px;
                font-size: 14px;
                flex: 1;
                min-width: 120px;
                justify-content: center;
            }

            .profile-button {
                right: 20px;
                position: fixed;
                top: 15px;
            }

            .profile-modal {
                right: 20px;
                top: 70px;
            }

            .dashboard-container {
                padding: 20px;
                width: 95%;
            }

            .quick-search-form {
                flex-direction: column;
            }

            .quick-search-form input {
                width: 100%;
            }

            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }

            .products-table {
                font-size: 12px;
            }

            .products-table th, .products-table td {
                padding: 8px;
            }
        }

        @media (max-width: 480px) {
            .top-menu a {
                font-size: 12px;
                padding: 8px 12px;
            }

            .dashboard-section {
                padding: 15px;
            }

            .welcome-section h1 {
                font-size: 2em;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- –í–µ—Ä—Ö–Ω–µ–µ –º–µ–Ω—é —Å –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π -->
    <div class="top-menu">
        <a href="{{ url_for('customer_products') }}">
            –¢–æ–≤–∞—Ä—ã –≤ –Ω–∞–ª–∏—á–∏–∏
        </a>
        <a href="{{ url_for('customer_search') }}">–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤</a>
        <a href="{{ url_for('customer_requests') }}">
            –ú–æ–∏ –∑–∞—è–≤–∫–∏
            <span class="notification-badge" id="requests-badge">{{ user_requests_count }}</span>
        </a>
        <a href="{{ url_for('customer_dashboard') }}">–ì–ª–∞–≤–Ω–∞—è</a>

        <button class="profile-button" id="profile-button">üë§</button>
        <div class="profile-modal" id="profile-modal">
            <a href="{{ url_for('logout') }}" style="color: #ff4757;">–í—ã–π—Ç–∏</a>
        </div>
    </div>

    <div class="dashboard-container">
        <!-- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ -->
        <div class="welcome-section">
            <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h1>
            <p id="current-date">–°–µ–≥–æ–¥–Ω—è: –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞—Ç—ã...</p>
        </div>

        <!-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="dashboard-section">
            <h2>–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-number">{{ total_products }}</div>
                    <div class="stat-label">–í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">{{ user_requests_count }}</div>
                    <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞—è–≤–æ–∫</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="unique-products">0</div>
                    <div class="stat-label">–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="products-without-shelf">0</div>
                    <div class="stat-label">–¢–æ–≤–∞—Ä–æ–≤ –±–µ–∑ –ø–æ–ª–∫–∏</div>
                </div>
            </div>
        </div>

        <!-- –¢–æ–≤–∞—Ä—ã -->
        <div class="dashboard-section">
            <h2>–¢–æ–≤–∞—Ä—ã –≤ –Ω–∞–ª–∏—á–∏–∏</h2>
            <p>–î–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –∑–∞–∫–∞–∑–∞: <strong>{{ total_products }}</strong> —Ç–æ–≤–∞—Ä–æ–≤</p>
            <p>–ù–æ–≤—ã—Ö –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–π: <strong id="new-products">0</strong></p>

            <div id="recent-products">
                <h3>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã:</h3>
                <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤...</div>
            </div>

            <a href="{{ url_for('customer_products') }}" class="dashboard-link">
                –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ —Ç–æ–≤–∞—Ä—ã ‚Üí
            </a>
        </div>

        <!-- –ü–æ–∏—Å–∫ -->
        <div class="dashboard-section">
            <h2>–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤</h2>
            <p>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∏—Å—Ç–µ–º—É –ø–æ–∏—Å–∫–∞ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è –Ω—É–∂–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤</p>

            <!-- –ë—ã—Å—Ç—Ä–∞—è —Ñ–æ—Ä–º–∞ –ø–æ–∏—Å–∫–∞ -->
            <form action="{{ url_for('customer_search') }}" method="GET" class="quick-search-form" id="search-form">
                <input type="text" name="q" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞, –∞—Ä—Ç–∏–∫—É–ª –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ QR-–∫–æ–¥–∞..." required>
                <button type="submit">–ù–∞–π—Ç–∏</button>
            </form>

            <a href="{{ url_for('customer_search') }}" class="dashboard-link">
                –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ ‚Üí
            </a>
        </div>

        <!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
        <div class="dashboard-section">
            <h2>–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h2>
            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                <button class="action-button secondary" onclick="window.location.href='{{ url_for('customer_products') }}'">
                    –í—Å–µ —Ç–æ–≤–∞—Ä—ã
                </button>
                <button class="action-button secondary" onclick="window.location.href='{{ url_for('customer_requests') }}'">
                    –ú–æ–∏ –∑–∞—è–≤–∫–∏
                </button>
                <button class="action-button secondary" onclick="window.location.href='{{ url_for('customer_search') }}'">
                    –ü–æ–∏—Å–∫
                </button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞—Ç—ã
            const now = new Date();
            const options = {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                weekday: 'long'
            };
            document.getElementById('current-date').textContent =
                '–°–µ–≥–æ–¥–Ω—è: ' + now.toLocaleDateString('ru-RU', options);

            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥–∞–ª—å–Ω—ã–º –æ–∫–Ω–æ–º –ø—Ä–æ—Ñ–∏–ª—è
            const profileButton = document.getElementById('profile-button');
            const profileModal = document.getElementById('profile-modal');

            profileButton.addEventListener('click', function(event) {
                event.stopPropagation();
                profileModal.style.display = profileModal.style.display === 'block' ? 'none' : 'block';
            });

            document.addEventListener('click', function(event) {
                if (!profileButton.contains(event.target) && !profileModal.contains(event.target)) {
                    profileModal.style.display = 'none';
                }
            });

            // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å —Å–µ—Ä–≤–µ—Ä–∞
            loadDashboardData();
        });

        // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –¥–∞—à–±–æ—Ä–¥–∞
        function loadDashboardData() {
            // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤
            fetch('/get_products')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(products => {
                    updateProductsStats(products);
                    displayRecentProducts(products);
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤:', error);
                    document.getElementById('recent-products').innerHTML = '<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤</p>';
                });
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤
        function updateProductsStats(products) {
            const totalProducts = products.length;
            const productsWithoutShelf = products.filter(p => !p.shelf).length;

            // –ü–æ–¥—Å—á–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ (–ø–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É QR-–∫–æ–¥–∞)
            const uniqueProducts = [...new Set(products.map(p => p.qr_content))].length;

            // –ù–æ–≤—ã–µ —Ç–æ–≤–∞—Ä—ã (–¥–æ–±–∞–≤–ª–µ–Ω—ã –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π)
            const newProducts = products.filter(p => {
                if (!p.created_at) return false;
                const addedDate = new Date(p.created_at);
                const daysDiff = (Date.now() - addedDate) / (1000 * 60 * 60 * 24);
                return daysDiff <= 7;
            }).length;

            document.getElementById('new-products').textContent = newProducts;
            document.getElementById('products-without-shelf').textContent = productsWithoutShelf;
            document.getElementById('unique-products').textContent = uniqueProducts;
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
        function displayRecentProducts(products) {
            const container = document.getElementById('recent-products');

            // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ç–æ–≤–∞—Ä—ã –ø–æ –¥–∞—Ç–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è (–ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–Ω–∞—á–∞–ª–∞)
            const sortedProducts = [...products].sort((a, b) => {
                const dateA = new Date(a.created_at || 0);
                const dateB = new Date(b.created_at || 0);
                return dateB - dateA;
            }).slice(0, 5); // –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ 5 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤

            if (sortedProducts.length === 0) {
                container.innerHTML = '<p>–¢–æ–≤–∞—Ä–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</p>';
                return;
            }

            let html = '<h3>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã:</h3><table class="products-table"><thead><tr><th>ID</th><th>–°–æ–¥–µ—Ä–∂–∏–º–æ–µ</th><th>–ü–æ–ª–∫–∞</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead><tbody>';

            sortedProducts.forEach(product => {
                html += `
                    <tr>
                        <td>${product.id}</td>
                        <td class="product-content">${product.qr_content}</td>
                        <td>
                            ${product.shelf ?
                                `<span class="shelf-name">${product.shelf.name}</span>` :
                                `<span class="no-shelf">–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞</span>`
                            }
                        </td>
                        <td>
                            <button class="action-button" onclick="createRequest(${product.id})">–ó–∞—è–≤–∫–∞</button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏
        function createRequest(productId) {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä?')) {
                fetch('/create_request/' + productId, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error(`Server error: ${text}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        alert('–ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!');
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∑–∞—è–≤–æ–∫
                        const currentCount = parseInt(document.getElementById('requests-badge').textContent);
                        document.getElementById('requests-badge').textContent = currentCount + 1;
                    } else {
                        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞—è–≤–∫–∏: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞—è–≤–∫–∏: ' + error.message);
                });
            }
        }
    </script>
</body>
</html>
